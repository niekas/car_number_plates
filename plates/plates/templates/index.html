<html>
<head>
    <title>Car Number Plates</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://use.fontawesome.com/releases/v5.0.4/css/all.css" rel="stylesheet">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://fb.me/react-15.0.0.js"></script>
    <script type="text/javascript" src="https://fb.me/react-dom-15.0.0.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/prop-types/15.6.1/prop-types.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/react/16.3.2/umd/react.production.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/react-dom/16.3.2/umd/react-dom.production.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/reactstrap/6.0.1/reactstrap.min.js"></script>
    <style>
     form {
       display: inline;
     }
     #owner-edit {
       max-width: 100%;
     }
     table {
        width: 500px;
        table-layout: fixed;
     }
    </style>


    <script type="text/babel">
    var owner_options = [
      ["-1", "------------"],
      {% for owner in owners %}
        [{{ owner.pk }}, "{{ owner }}"],
      {% endfor %}
    ];

    function get_owner(key) {
      for (var i=0; i < owner_options.length; i++) {
        if (owner_options[i][0] == key) {
            return owner_options[i][1];
        };
      };
    };

     class NumberPlate extends React.Component {
        constructor(props) {
          super(props);
            this.state = {
              owner: props.owner,
              owner_id: props.owner_id,
              number_plate: props.number_plate,
              number_plate_id: props.number_plate_id,
              deleted: props.deleted,
              editable: props.editable
            };
            this.handleNumberPlateChange = this.handleNumberPlateChange.bind(this);
            this.handleOwnerChange = this.handleOwnerChange.bind(this);
            this.handleDelete = this.handleDelete.bind(this);
        };
        handleNumberPlateChange(event) {this.setState({number_plate: event.target.value});};
        handleOwnerChange(event) {
            this.setState({owner_id: event.target.value});
            this.setState({owner: get_owner(event.target.value)});
        };

        toggleEditable(event) {
            if (this.state['editable'] === true) {
              fetch('/api/numberplates/'+ this.state.number_plate_id + '/' , {
                method: 'PATCH',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  'owner': '/api/owners/' + this.state.owner_id + '/',
                  'number': this.state.number_plate,
                  'id': this.state.number_plate_id})
              }).then(function (resp) {
              }).catch(function (err) {
              });
            };
            this.setState({editable: !this.state['editable']});
        };

        handleDelete(event) {
          function handleDELETEResponse(resp) {
            this.setState({deleted: true});
          };
          handleDELETEResponse = handleDELETEResponse.bind(this);

          fetch('/api/numberplates/' + this.state.number_plate_id + '/', {
            method: 'DELETE',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
          }).then(handleDELETEResponse);
        };

        render() {
          if (this.state.deleted === true) return null;

          if (this.state.editable === true) {
            const owner_select = owner_options.map(function(owner) {
              if (owner[0] !== '-1')
                return <option value={ owner[0] }>{ owner[1] }</option>
            });
            return (
            <tr>
              <td>
                <input class="form-control" size="6" name="number_plate"  onChange={ this.handleNumberPlateChange } value={ this.state.number_plate }/>
                <input class="form-control" type="hidden" size="6" name="number_plate_id" value={ this.state.number_plate_id }/>
              </td>
              <td>
                <select id='owner-edit' ref='owner' name='owner' class="custom-select" value={this.state.owner_id} onChange={this.handleOwnerChange}>
                  { owner_select }
                </select>
              </td>
              <td>
                  <button class="btn btn-outline-dark" type="button" id="button-addon3" onClick={ this.toggleEditable.bind(this, this.state.number_plate_id) }>
                    <i class="fas fa-save"></i>
                  </button>&nbsp;
                  <button class="btn btn-outline-danger" type="button" id="button-addon3" onClick={ this.handleDelete }>
                    <i class="fas fa-trash"></i>
                  </button>
              </td>
            </tr>
            );
          };
          return (
          <tr>
            <td>
              { this.state.number_plate }
              <input class="form-control" type="hidden" size="6" name="number_plate" value={ this.state.number_plate }/>
              <input class="form-control" type="hidden" size="6" name="number_plate_id" value={ this.state.number_plate_id }/>
            </td>
            <td>
              { this.state.owner }
              <input class="form-control" type="hidden" size="6" name="owner" value={ this.state.owner }/>
              <input class="form-control" type="hidden" size="6" name="owner_id" value={ this.state.owner_id }/>
            </td>
            <td>
                <button class="btn btn-outline-primary" type="button" id="button-addon3" onClick={ this.toggleEditable.bind(this, this.state.number_plate_id) }>
                  <i class="fas fa-edit"></i>
                </button>&nbsp;
                <button class="btn btn-outline-danger" type="button" id="button-addon3" onClick={ this.handleDelete }>
                  <i class="fas fa-trash"></i>
                </button>
            </td>
          </tr>
          );
        }
     };

     class NumberPlateTable extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            new_number_plate: '',
            new_owner_id: '-1',
            error_message: null,
            number_plates: [
              {% for number_plate in number_plates %}
                {
                  'number_plate_id': '{{ number_plate.pk }}',
                  'number_plate': '{{ number_plate }}',
                  'owner': '{{ number_plate.owner }}',
                  'owner_id': '{{ number_plate.owner.pk }}',
                  'deleted': false,
                  'editable': false
                },
              {% endfor %}
              ]
          };

          this.resetNewNumberPlateState = this.resetNewNumberPlateState.bind(this);
          this.handleOwnerChange = this.handleOwnerChange.bind(this);
          this.handleNumberPlateChange = this.handleNumberPlateChange.bind(this);
          this.handleCreate = this.handleCreate.bind(this);
        };

        resetNewNumberPlateState() {
          this.setState({new_number_plate: '', new_owner_id: '-1'});
        };

        handleOwnerChange(event) {
          this.setState({new_owner_id: event.target.value});
        };

        handleNumberPlateChange(event) {
          this.setState({new_number_plate: event.target.value});
        };

        handleCreate(event) {
          event.preventDefault();
          function handlePOSTResponse(resp) {
            resp.json().then(json => {
              var new_element = {
                owner_id: this.state.new_owner_id,
                number_plate: this.state.new_number_plate,
                number_plate_id: json['id'],
                owner: get_owner(this.state.new_owner_id)
              };
              this.setState({number_plates: [...this.state.number_plates, new_element]});
              this.resetNewNumberPlateState();
            });
          };
          handlePOSTResponse = handlePOSTResponse.bind(this);

          fetch('/api/numberplates/', {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              'owner': '/api/owners/' + this.state.new_owner_id + '/',
              'number': this.state.new_number_plate})
            }).then(handlePOSTResponse).catch(function (err) {
                this.setState({error_message: err});
            });
        };

        render() {
            return ([
              <tr>
                <td colspan="3">
                  <form onSubmit={ this.handleCreate }>
                    {% csrf_token %}
                    <div class="input-group">
                      <input id='number_plate' class="form-control" type="text" name="number_plate" placeholder="Car plate"
                             size="10" aria-describedby="button-addon1" onChange={this.handleNumberPlateChange} value={ this.state.new_number_plate } />
                      <select id='owner' ref='owner' name='owner' class="custom-select" id="inputGroupSelect02" value={this.state.new_owner_id} onChange={this.handleOwnerChange}>
                        <option value="-1">------------</option>
                        {% for owner in owners %}
                          <option value="{{ owner.pk }}">{{ owner }}</option>
                        {% endfor %}
                      </select>
                      <div class="input-group-append">
                        <button class="btn btn-outline-primary" type="submit" id="button-addon1">
                          <i class="fas fa-plus-square"></i>
                        </button>
                      </div>
                    </div>
                  </form>
                </td>
              </tr>,
                this.state.number_plates.map(data => {
                  return <NumberPlate number_plate={data.number_plate} number_plate_id={data.number_plate_id}
                                 owner={data.owner} owner_id={data.owner_id} deleted={data.deleted} editable={ data.editable } />
                })]
            );
        }
     };

     class Owner extends React.Component {
        constructor(props) {
          super(props);
            this.state = {
              owner_id: props.owner_id,
              first_name: props.first_name,
              last_name: props.last_name,
              deleted: props.deleted,
              editable: props.editable
            };
            this.handleFirstNameChange = this.handleFirstNameChange.bind(this);
            this.handleLastNameChange = this.handleLastNameChange.bind(this);
            this.handleDelete = this.handleDelete.bind(this);
        };

        handleFirstNameChange(event) {this.setState({first_name: event.target.value});};
        handleLastNameChange(event) {this.setState({last_name: event.target.value});};
        toggleEditable(event) {
            if (this.state['editable'] === true) {
              fetch('/api/owners/'+ this.state.owner_id + '/' , {
                method: 'PATCH',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  'first_name': this.state.first_name,
                  'last_name': this.state.last_name,
                  'id': this.state.owner_id})
              }).then(function (resp) {
                resp.json().then(json => {
                    console.log(json);
                });
              }).catch(function (err) {
              });
            };
            this.setState({editable: !this.state['editable']});
        };

        handleDelete(event) {
          function handleDELETEResponse(resp) {
            this.setState({deleted: true});
          };
          handleDELETEResponse = handleDELETEResponse.bind(this);

          fetch('/api/owners/' + this.state.owner_id + '/', {
            method: 'DELETE',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
          }).then(handleDELETEResponse);
        };

        render() {
          if (this.state.deleted === true) return null;
          if (this.state.editable === true) {
            return (
            <tr>
              <td>
                <div class="input-group">
                  <input class="form-control" placeholder="First name" name="number_plate" onChange={ this.handleFirstNameChange } value={ this.state.first_name }/>
                  <input class="form-control" placeholder="Last name" name="number_plate_id" onChange={ this.handleLastNameChange } value={ this.state.last_name }/>
                </div>
              </td>
              <td>
                  <button class="btn btn-outline-dark" type="button" id="button-addon3" onClick={ this.toggleEditable.bind(this, this.state.owner_id) }>
                    <i class="fas fa-save"></i>
                  </button>&nbsp;
                  <button class="btn btn-outline-danger" type="button" id="button-addon3" onClick={ this.handleDelete }>
                    <i class="fas fa-trash"></i>
                  </button>
              </td>
            </tr>
            );
          };
          return (
            <tr>
              <td>
              <div class="input-group">
                <input class="form-control" type="hidden" size="6" name="owner_id" value={ this.state.owner_id }/>
                { this.state.first_name } { this.state.last_name }
              </div>
              </td>
              <td>
                  <button class="btn btn-outline-primary" type="button" id="button-addon3" onClick={ this.toggleEditable.bind(this, this.state.number_plate_id) }>
                    <i class="fas fa-edit"></i>
                  </button>&nbsp;
                  <button class="btn btn-outline-danger" type="button" id="button-addon3" onClick={ this.handleDelete }>
                    <i class="fas fa-trash"></i>
                  </button>
              </td>
            </tr>
          );
        };
      };





     class OwnerTable extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            new_first_name: '',
            new_last_name: '',
            error_message: '',
            owners: [
              {% for owner in owners %}
                {
                  'owner_id': '{{ owner.pk }}',
                  'first_name': '{{ owner.first_name }}',
                  'last_name': '{{ owner.last_name }}',
                  'deleted': false,
                  'editable': false
                },
              {% endfor %}
              ]
          };

          this.resetNewOwnerState = this.resetNewOwnerState.bind(this);
          this.handleFirstNameChange = this.handleFirstNameChange.bind(this);
          this.handleLastNameChange = this.handleLastNameChange.bind(this);
          this.handleCreate = this.handleCreate.bind(this);
        };

        resetNewOwnerState(event) {
            this.setState({new_first_name: '', new_last_name: ''});
        };
        handleFirstNameChange(event) { this.setState({new_first_name: event.target.value}); };
        handleLastNameChange(event) { this.setState({new_last_name: event.target.value}); };
        handleCreate(event) {
          event.preventDefault();

          function handlePOSTResponse(resp) {
            resp.json().then(json => {
              var new_element = {
                owner_id: json['id'],
                first_name: this.state.new_first_name,
                last_name: this.state.new_last_name,
              };
              this.setState({owners: [...this.state.owners, new_element]});
              owner_options.push([json['id'], this.state.new_first_name + ' ' + this.state.new_last_name]);
              this.resetNewOwnerState();
            });
          };
          handlePOSTResponse = handlePOSTResponse.bind(this);

          fetch('/api/owners/', {
            method: 'POST',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              first_name: this.state.new_first_name,
              last_name: this.state.new_last_name,
              'number_plate': []})
            }).then(handlePOSTResponse).catch(function (err) {
                this.setState({error_message: err});
            });
        };

        render() {
            return ([
            <tr>
              <td colspan="2">
                <form onSubmit={ this.handleCreate }>
                  <div class="input-group">
                    <input id='first_name' class="form-control" type="text" name="fname" placeholder="First name" size="10" aria-describedby="button-addon2" value={this.state.new_first_name} onChange={this.handleFirstNameChange} />
                    <input id='last_name' class="form-control" type="text" name="lname" placeholder="Last name" size="10" aria-describedby="button-addon2" value={this.state.new_last_name} onChange={this.handleLastNameChange} />
                    <div class="input-group-append">
                      <button class="btn btn-outline-primary" type="submit" id="button-addon2">
                        <i class="fas fa-plus-square"></i>
                      </button>
                    </div>
                  </div>
                </form>
              </td>
            </tr>,
                this.state.owners.map(data => {
                  return <Owner first_name={data.first_name} last_name={data.last_name} owner_id={data.owner_id}
                                 deleted={data.deleted} editable={ data.editable } />
                })]
            );
        }
    };


      ReactDOM.render(
        <NumberPlateTable />,
        document.getElementById('number-plate-table')
      );

      ReactDOM.render(
        <OwnerTable />,
        document.getElementById('owner-table')
      );


    </script>

</head>

<body>
  <div style="width:500px; margin:5% auto;">

    <div style="margin-bottom: 30px;">
      <table id="number-plates-tbl" class='table-striped table-bordered' cellpadding="10">
        <thead>
          <tr>
            <th>Car number plate</th>
            <th>Owner</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="number-plate-table"/>
      </table>
    </div>

    <div>
      <table id="owners" class='table-striped table-bordered' cellpadding="10">
        <thead>
          <tr>
            <th>Owner</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="owner-table"/>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
